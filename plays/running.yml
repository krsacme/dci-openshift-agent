---
- name: set EXTERNAL_SUBNET
  set_fact:
    extcidrnet: "{{ ip | ipaddr('network') }}/{{ ip | ipaddr('prefix') }}"
  vars:
    ip: "{{ ansible_default_ipv4.address }}/{{ ansible_default_ipv4.netmask }}"

- name: Get version and build from localhost vars
  set_fact:
    version: "{{ hostvars.localhost.version }}"
    build: "{{ hostvars.localhost.build }}"

- name: Get pullsecret from localhost vars
  set_fact:
    pullsecret: "{{ hostvars.localhost.pullsecret| to_json }}"
  no_log: true

- name: Populate clusterosimage from fetch_bits
  set_fact:
    clusterosimage: "{{ hostvars.localhost.clusterosimage }}"
  when: hostvars.localhost.clusterosimage is defined

- name: Populate bootstraposimage from fetch_bits
  set_fact:
    bootstraposimage: "{{ hostvars.localhost.bootstraposimage }}"
  when: hostvars.localhost.bootstraposimage is defined

- name: Process catalog source mirrors
  when: redhat_catalog_image_sources|default([])|length > 0
  block:
    - name: Set facts required populating redhat-catalog mirrors
      set_fact:
        img_extras: []
        registry: "{{ local_registry }}/"

    - name: Update the list with the required format
      set_fact:
        img_extras: "{{ img_extras + [{ 'source': item, 'mirrors': [ registry + item.split('/')[1:]|join('/') ] }] }}"
      loop: "{{ redhat_catalog_image_sources }}"

    - name: Set image_content_source_extras fact for the installer role
      set_fact:
        image_content_source_extras: "{{ img_extras }}"

- import_role:
    name: node-prep

- import_role:
    name: installer
